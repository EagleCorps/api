#!/bin/zsh

SIGNING_ALGORITHM_CURRENT=$(grep -o -P "(?<=NEXT_PUBLIC_HASURA_JWT_SIGNING_ALGORITHM_UPCOMING\=').*(?=')" .env.local)
PUBLIC_KEY_CURRENT=$(grep -o -P "(?<=NEXT_PUBLIC_HASURA_JWT_PUBLIC_KEY_UPCOMING\=').*(?=')" .env.local)
PRIVATE_KEY_CURRENT=$(grep -o -P "(?<=HASURA_JWT_PRIVATE_KEY_UPCOMING\=').*(?=')" .env.local)

SIGNING_ALGORITHM_OPENSSL=ed25519
SIGNING_ALGORITHM_JOSE=EdDSA
PRIVATE_KEY_UPCOMING=$(openssl genpkey -algorithm $SIGNING_ALGORITHM_OPENSSL)
PUBLIC_KEY_UPCOMING=$(echo -n $PRIVATE_KEY_UPCOMING | openssl pkey -pubout)

sed -i "s/^NEXT_PUBLIC_HASURA_JWT_SIGNING_ALGORITHM_CURRENT='.*$/NEXT_PUBLIC_HASURA_JWT_SIGNING_ALGORITHM_CURRENT='$SIGNING_ALGORITHM_CURRENT'/g" .env.local
sed -i "s/^NEXT_PUBLIC_HASURA_JWT_PUBLIC_KEY_CURRENT='.*$/NEXT_PUBLIC_HASURA_JWT_PUBLIC_KEY_CURRENT='$(${0:A:h}/escape-key $PUBLIC_KEY_CURRENT)'/g" .env.local
sed -i "s/^HASURA_JWT_PRIVATE_KEY_CURRENT='.*$/HASURA_JWT_PRIVATE_KEY_CURRENT='$(${0:A:h}/escape-key $PRIVATE_KEY_CURRENT)'/g" .env.local
sed -i "s/^NEXT_PUBLIC_HASURA_JWT_SIGNING_ALGORITHM_UPCOMING='.*$/NEXT_PUBLIC_HASURA_JWT_SIGNING_ALGORITHM_UPCOMING='$SIGNING_ALGORITHM_JOSE'/g" .env.local
sed -i "s/^NEXT_PUBLIC_HASURA_JWT_PUBLIC_KEY_UPCOMING='.*$/NEXT_PUBLIC_HASURA_JWT_PUBLIC_KEY_UPCOMING='$(${0:A:h}/escape-key $PUBLIC_KEY_UPCOMING)'/g" .env.local
sed -i "s/^HASURA_JWT_PRIVATE_KEY_UPCOMING='.*$/HASURA_JWT_PRIVATE_KEY_UPCOMING='$(${0:A:h}/escape-key $PRIVATE_KEY_UPCOMING)'/g" .env.local
